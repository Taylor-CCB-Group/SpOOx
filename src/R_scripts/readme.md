## RPhenoHarmonyCluster.R

### Basics

The script carries out two types of clustering based on the specified markers. First Rphenograph is used alone, then Harmony is used to produce PCs, which are then clustered with Rphenograph. Optionally, dimension reduction (UMAP/tsNE) are performed on these PCs. 

The input to the script is a single tab delimited table specified in the  _--input_file_. The markers to use can either be specified in the _--panel_file_ or in _--metadata_cols_.

The output directory is specified in _--output_dir_ (which defaults to the current working directory). The output file will be a tab delimited table with the clusters and dimension reduction (clusters.txt)  and if _--save_sceobj_ is true an RData file will be saved as well.
If specified PCAs will be written to the pca.txt file. A number of charts are also produced

**N.B.** The fist time the script is run, an R package that is not present in Conda will be downloaded and installed, which can take a few minutes

### Examples

To run from the cellData.tan file produced by _mergecelldata.py_ with default settings:-

    Rscript RPhenoHarmonyCluster.R \
        --input_file /path/to/cellData.tab \
        --panel_file /path/to/panel.tsv \
        --output_dir /path/to/output \


To run from a table containing only cellID, sample_name and marker columns and output only cellID and cluster information :-

    Rscript RPhenoHarmonyCluster_R \
        --input_file /path/to/cellData.tab \
        --output_clusters_only TRUE \
        --create_sample_columns FALSE \
        --output_dir /path/to/output \

Using a table where the first 10 columns are metadata and the rest are markers, using the batch column to normalize:-

     Rscript RPhenoHarmonyCluster_R \
        --input_file /path/to/cellData.tab \
        --metadata_cols 10 \
        --create_sample_columns FALSE \
        --output_dir /path/to/output \
        --var batch

### Arguments

* **--k** The k parameter for Rphenograph - default is 30

* **--q** The quantile used for trimming/scaling - default is 0.01

* **--datatransf** The data transformation that will be performed on the markers before Rphenograph clustering. Options are none, scaled, scaledtrim . The default is scaledtrim. No transformation is applied in the Harmony step as it has its own scaling function.

* **--panel_file** The path to the panel file which should have at least two columns, _marker_name_ with the name of the marker and _clustering_ which should contain a 1 if to be used in the clustering e.g

        marker_name   clustering
        CD14          1
        C27           0
        
   The default is NULL, in which case the --metadata_cols argument specifies which columns to use as markers


* **--metadata_cols** If _--panel_file_ is NULL, all columns after the _metadata_cols_ argument will be used as markers. It defaults to 2 e.g. could be the cellID and sample_name, which is used in the harmony step.

* **--var**  The column used by Harmony to normalise the data. The default is sample_name.

* **--create_sample_columns** If TRUE the the columns condition,sample_id,sample_name and ROI are automatically generated from the cellID column, which must be present and in the format cond_sample_x_roi_y. The default is TRUE.

* **--output_clusters_only** By default all columns in the initial table plus those generated in the clustering are written out in the final file. If *--output_clusters_only* is TRUE, only cellID (must be present) and the cluster columns will be written. Default is FALSE.

* **--run_dimRed** Run dimension reduction on the PCs generated by harmony . Possible values are UMAP,TSNE,BOTH or NONE. The default is UMAP.

* **--num_dimensions** The number of dimensions to use in the dimension reduction . Can be any number above 1, the default is 3

* **--npcs** The number of PCs that harmony generates and are used in the subsequent phenograph step. The default is 20. However, if _npcs_ is greater or equal to the number of markers it will be reduced to the number of markers -1

* **--set_seed** The seed to be used in the clustering/dimension reductions. Using the same seed with the same input data and parameters should produce exactly the same results. The default is NULL in which case a random seed will be used.

* **--group_pcas** if not _none_ then the marker data will be collapsed according to this column and PCA performed. A file pca.txt will be written to the output folder with 4 PCs for each unique value in the specified column. If the number od groups is less then 4 then this step will not be performed. The default value is _sample_id_